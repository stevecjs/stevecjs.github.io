<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>夢想藍圖</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  
  <style>
    :root {
        --sidebar-width: 260px;
        --primary-color: #2c3e50;
        --bg-light: #f5f7fa;
    }
    body { background-color: var(--bg-light); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-user-select: none; user-select: none; overflow-x: hidden;}
    
    /* 通用樣式 */
    .card { border: none; box-shadow: 0 2px 6px rgba(0,0,0,0.04); margin-bottom: 12px; border-radius: 12px; transition: transform 0.15s ease; }
    .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .item-row { padding: 15px; background: white; }
    .item-top-row { display: flex; align-items: flex-start; margin-bottom: 10px; }
    .item-content-text { font-size: 1rem; font-weight: 600; color: var(--primary-color); flex-grow: 1; word-break: break-word; line-height: 1.5;}
    .item-bottom-row { display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px solid #f8f9fa; }
    
    .star-btn { color: #ecf0f1; cursor: pointer; font-size: 1.3rem; margin-right: 12px; transition: color 0.2s; }
    .star-btn.active { color: #f1c40f; filter: drop-shadow(0 1px 2px rgba(241, 196, 15, 0.3)); }
    .strikethrough { text-decoration: line-through; color: #bdc3c7; }
    .opacity-50 { opacity: 0.5; }
    
    /* --- 優化後的天數與按鈕樣式 --- */
    .days-badge { 
        font-size: 0.9rem; /* 字體放大 */
        padding: 6px 14px; /* 按鈕加大 */
        border-radius: 20px; 
        background: #ecf0f1; 
        color: #7f8c8d; 
        font-weight: 600; 
        display: inline-flex; 
        align-items: center;
        margin-right: 10px;
    }
    .days-badge.overdue { background: #fadbd8; color: #c0392b; } /* 過期很久 (紅) */
    .days-badge.future { background: #e8f6f3; color: #16a085; } /* 未來 (藍綠) */
    .days-badge.today { background: #d4efdf; color: #27ae60; } /* 今天 (綠) */
    
    .btn-reset {
        font-size: 0.9rem; /* 字體放大 */
        padding: 6px 14px; /* 按鈕加大 */
        border-radius: 20px;
        background-color: #f0fdf4;
        color: #27ae60;
        border: 1px solid #dcfce7;
        transition: all 0.2s;
    }
    .btn-reset:active { background-color: #dcfce7; transform: scale(0.95); }

    .btn-icon-text { font-size: 0.8rem; padding: 6px 12px; border-radius: 8px; }
    .category-header { padding: 25px; background: white; margin-bottom: 20px; border-radius: 0 0 25px 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
    .form-control:focus { box-shadow: none; border-color: #bdc3c7; }
    
    .goal-textarea { transition: border-color 0.3s, background-color 0.3s; border: 1px solid transparent; }
    .goal-textarea.saving { border-color: #f1c40f !important; background-color: #fff9db !important; }
    .goal-textarea.saved { border-color: #2ecc71 !important; background-color: #eafaf1 !important; }

    /* 讀取與登入遮罩 */
    #loading, #login-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.98); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction: column;}
    #login-overlay { z-index: 10000; background: var(--bg-light); }

    /* ================= 桌機版樣式 (大於 992px) ================= */
    @media (min-width: 992px) {
        body { padding-bottom: 0; }
        .layout-wrapper {
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr;
            min-height: 100vh;
        }
        .sidebar {
            background: white; padding: 30px 20px; border-right: 1px solid #eee;
            display: flex; flex-direction: column; position: sticky; top: 0; height: 100vh;
        }
        .sidebar-brand { font-size: 1.5rem; font-weight: 800; color: var(--primary-color); margin-bottom: 40px; display: flex; align-items: center; }
        .sidebar-menu { flex-grow: 1; display: flex; flex-direction: column; gap: 10px; }
        .sidebar-item {
            display: flex; align-items: center; padding: 12px 18px; text-decoration: none; color: #7f8c8d; border-radius: 12px; transition: all 0.2s; font-weight: 600;
        }
        .sidebar-item:hover { background-color: #f8f9fa; color: var(--primary-color); }
        .sidebar-item.active { background-color: #eaf2f8; color: #2980b9; }
        .sidebar-item i { width: 25px; font-size: 1.1rem; margin-right: 10px; }

        .main-content { padding: 30px 40px; overflow-y: auto; }
        .category-header { border-radius: 25px; margin-top: 0; } 

        .desktop-two-col-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: start;
        }
        .nav-container { display: none !important; }
    }

    /* ================= 手機版樣式 (小於 992px) ================= */
    @media (max-width: 991.98px) {
        body { padding-bottom: 130px; }
        .layout-wrapper { display: block; } 
        .sidebar { display: none; }
        .main-content { padding: 0; }
        .desktop-two-col-grid { display: block; }
        .col-block { margin-bottom: 30px; }

        .nav-container { position: fixed; bottom: 0; left: 0; width: 100%; background: white; z-index: 1000; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .nav-categories-scroll { display: flex; overflow-x: auto; white-space: nowrap; padding: 10px 5px; -ms-overflow-style: none; scrollbar-width: none; border-bottom: 1px solid #f0f0f0; }
        .nav-categories-scroll::-webkit-scrollbar { display: none; }
        .nav-cat-item { display: inline-flex; flex-direction: column; align-items: center; min-width: 70px; padding: 8px 5px; color: #95a5a6; text-decoration: none; border-radius: 10px; transition: 0.2s; margin: 0 2px;}
        .nav-cat-item.active { background-color: #eaf2f8; color: #2980b9; font-weight: bold; }
        .nav-cat-item i { font-size: 1.2rem; margin-bottom: 4px; }
        .nav-cat-item span { font-size: 0.7rem; }
        .nav-home-area { padding: 10px 15px; background: white; }
        .btn-home-large { width: 100%; background: var(--primary-color); color: white; border: none; border-radius: 50px; padding: 12px; font-weight: 700; transition: 0.1s; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 10px rgba(44, 62, 80, 0.3);}
        .btn-home-large:active { transform: scale(0.98); }
        .btn-home-large.active { background: #34495e; }
    }
  </style>
</head>
<body>

  <div id="login-overlay">
    <div class="mb-5 text-center p-4">
      <h1 class="fw-bold mb-3" style="color: var(--primary-color); font-size: 2.5rem;"><i class="fa-solid fa-rocket me-3"></i>夢想藍圖</h1>
      <p class="text-secondary lead">請使用 Google 帳號登入以同步資料</p>
    </div>
    <div id="g_id_onload"
         data-client_id="588153257798-88o3tpdc6m8545frq4qcsd3ou31cnhgn.apps.googleusercontent.com"
         data-callback="handleCredentialResponse"
         data-auto_select="true"
         data-auto_prompt="false">
    </div>
    <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with" data-shape="pill" data-logo_alignment="left"></div>
  </div>

  <div id="loading" style="display:none;">
    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
    <div class="text-secondary fw-bold">資料同步中...</div>
  </div>

  <div class="layout-wrapper">
      <nav class="sidebar">
          <div class="sidebar-brand">
              <i class="fa-solid fa-rocket me-3 text-primary"></i>夢想藍圖
          </div>
          <div class="sidebar-menu" id="sidebar-menu-container"></div>
      </nav>

      <main class="main-content" id="app-content"></main>
  </div>

  <div class="nav-container">
    <div class="nav-categories-scroll" id="nav-categories"></div>
    <div class="nav-home-area">
      <button class="btn-home-large" id="btn-home-large" onclick="switchCategory('Home')">
        <i class="fa-solid fa-house me-2"></i> 首頁 / 整體目標
      </button>
    </div>
  </div>

  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
        <div class="modal-header border-0 pb-0 px-4 pt-4">
            <h5 class="modal-title fw-bold text-dark" id="modalTitle">編輯項目</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body px-4 pt-3">
          <input type="hidden" id="editId"><input type="hidden" id="editType">
          <textarea class="form-control mb-3 p-3 bg-light border-0 shadow-sm" id="editContent" rows="5" placeholder="輸入內容..." style="font-size:1.1rem; border-radius: 15px; resize: none;"></textarea>
          <div id="editDateGroup" class="d-none bg-light p-3 shadow-sm" style="border-radius: 15px;">
             <label class="form-label text-muted small fw-bold mb-2"><i class="fa-regular fa-calendar me-1"></i>設定日期</label>
             <input type="date" class="form-control border-0 bg-white shadow-sm" id="editDate" style="border-radius: 10px;">
          </div>
        </div>
        <div class="modal-footer border-0 px-4 pb-4 pt-2">
          <button type="button" class="btn btn-light text-danger me-auto rounded-pill px-3" id="btnDelete"><i class="fa-solid fa-trash me-2"></i>刪除</button>
          <button type="button" class="btn btn-primary px-5 rounded-pill fw-bold shadow-sm" id="btnSave">儲存</button>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

<script>
  // ===========================================
  // 設定區
  // ===========================================
  const API_URL = "https://script.google.com/macros/s/AKfycbwVnq_72ZvV6uIzXGUmnChvJH8UYkFUYdSHwaOQotUg4o35YL_hmbIWeM3yT9KDgWs3UQ/exec"; 
  // ===========================================

  let userToken = localStorage.getItem("google_token");
  let allData = [];
  let currentCategory = 'Home';
  let editModal;

  const DOMAINS = [
    { id: 'Health', name: '健康', icon: 'fa-heart-pulse' },
    { id: 'Rest', name: '休養', icon: 'fa-book-open' },
    { id: 'Spirit', name: '心靈', icon: 'fa-spa' },
    { id: 'Work', name: '工作', icon: 'fa-briefcase' },
    { id: 'Family', name: '家庭', icon: 'fa-user-group' },
    { id: 'Money', name: '經濟', icon: 'fa-sack-dollar' }
  ];
  
  const CATEGORY_HOME = { id: 'Home', name: '首頁總覽', icon: 'fa-house' };

  window.onload = function() {
    renderNavbar();
    editModal = new bootstrap.Modal(document.getElementById('editModal'));
    document.getElementById('btnSave').onclick = saveEdit;
    document.getElementById('btnDelete').onclick = deleteEdit;

    if (userToken) {
      document.getElementById('login-overlay').style.display = 'none';
      loadData();
    }
  };

  function handleCredentialResponse(response) {
    userToken = response.credential;
    localStorage.setItem("google_token", userToken);
    document.getElementById('login-overlay').style.display = 'none';
    loadData();
  }

  async function callApi(action, payload = {}) {
    if (!userToken) { document.getElementById('login-overlay').style.display = 'flex'; return null; }
    try {
      payload.token = userToken; 
      let response = await fetch(API_URL, {
        method: 'POST',
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action: action, ...payload })
      });
      const data = await response.json();
      if (data && data.error === 'Unauthorized') {
        alert("登入已過期，請重新登入");
        localStorage.removeItem("google_token"); userToken = null;
        document.getElementById('login-overlay').style.display = 'flex'; return null;
      }
      return data;
    } catch (error) { console.error(error); alert('無法連線到伺服器'); document.getElementById('loading').style.display = 'none'; return null; }
  }

  async function loadData() {
    document.getElementById('loading').style.display = 'flex';
    const res = await callApi('getData');
    if (res) { allData = res.items || []; renderContent(); }
    document.getElementById('loading').style.display = 'none';
  }

  // --- UI 渲染 ---
  function renderNavbar() {
    const navScroll = document.getElementById('nav-categories');
    navScroll.innerHTML = DOMAINS.map(cat => `
      <a href="javascript:void(0)" class="nav-cat-item ${cat.id === currentCategory ? 'active' : ''}" onclick="switchCategory('${cat.id}')">
        <i class="fa-solid ${cat.icon}"></i><span>${cat.name}</span>
      </a>
    `).join('');
    
    const btnHome = document.getElementById('btn-home-large');
    if (currentCategory === 'Home') {
      btnHome.classList.add('active'); btnHome.innerHTML = '<i class="fa-solid fa-house me-2"></i> 首頁 / 整體目標';
    } else {
      btnHome.classList.remove('active'); btnHome.innerHTML = '<i class="fa-solid fa-house me-2"></i> 回首頁';
    }

    const sidebarMenu = document.getElementById('sidebar-menu-container');
    let sidebarHtml = `
        <a href="javascript:void(0)" class="sidebar-item ${currentCategory === 'Home' ? 'active' : ''} mb-3" onclick="switchCategory('Home')">
            <i class="fa-solid ${CATEGORY_HOME.icon}"></i>${CATEGORY_HOME.name}
        </a>
        <div class="text-muted small fw-bold mb-2 ps-3">生活領域</div>
    `;
    sidebarHtml += DOMAINS.map(cat => `
      <a href="javascript:void(0)" class="sidebar-item ${cat.id === currentCategory ? 'active' : ''}" onclick="switchCategory('${cat.id}')">
        <i class="fa-solid ${cat.icon}"></i>${cat.name}
      </a>
    `).join('');
    sidebarMenu.innerHTML = sidebarHtml;
  }

  function switchCategory(id) {
    currentCategory = id;
    renderNavbar();
    if(window.innerWidth < 992) window.scrollTo(0,0);
    renderContent();
  }

  function renderContent() {
    const container = document.getElementById('app-content');
    container.innerHTML = '';
    
    let catInfo = (currentCategory === 'Home') ? CATEGORY_HOME : DOMAINS.find(c=>c.id===currentCategory);
    let goal = allData.find(d => d.category === currentCategory && d.type === 'Goal')?.content || '';
    let headerIcon = currentCategory === 'Home' ? 'fa-earth-americas' : catInfo.icon;
    
    let headerHtml = `
      <div class="category-header">
        <h4 class="mb-4 text-dark fw-bolder"><i class="fa-solid ${headerIcon} me-3 text-primary"></i>${catInfo.name}目標</h4>
        <textarea class="form-control goal-textarea bg-light shadow-sm p-4" rows="3" style="border-radius: 15px; resize: none; font-size: 1.1rem;" placeholder="寫下此領域最重要的目標與願景..." onblur="saveTopGoal(this)">${goal}</textarea>
        <div class="text-end mt-1"><small class="text-muted" id="save-status-text" style="opacity:0; transition: opacity 0.3s;">已儲存</small></div>
      </div>`;
    container.innerHTML = headerHtml;

    if (currentCategory === 'Home') {
      let starred = allData.filter(d => d.isStarred && d.type !== 'Goal');
      container.innerHTML += `<div class="px-3 px-lg-0 pb-3"><div class="text-secondary fw-bold mb-3 ps-2"><i class="fa-solid fa-star text-warning me-2"></i>重點關注項目</div><div id="list-home"></div></div>`;
      renderList(document.getElementById('list-home'), starred, false);
    } else {
      let reminders = allData.filter(d => d.category === currentCategory && d.type === 'Reminder');
      let todos = allData.filter(d => d.category === currentCategory && d.type === 'Todo');
      
      container.innerHTML += `
        <div class="desktop-two-col-grid px-3 px-lg-0 pb-5">
            <div class="col-block">
                <div class="d-flex justify-content-between align-items-center mb-3 ps-2">
                    <span class="fw-bold text-secondary"><i class="fa-solid fa-bell me-2"></i>提醒與追蹤</span>
                    <button class="btn btn-sm btn-primary rounded-circle shadow-sm" style="width:32px;height:32px;" onclick="openAddModal('Reminder')"><i class="fa-solid fa-plus"></i></button>
                </div>
                <div id="list-rem"></div>
            </div>
            <div class="col-block">
                 <div class="d-flex justify-content-between align-items-center mb-3 ps-2 mt-4 mt-lg-0">
                    <span class="fw-bold text-secondary"><i class="fa-solid fa-list-check me-2"></i>待辦事項</span>
                    <button class="btn btn-sm btn-primary rounded-circle shadow-sm" style="width:32px;height:32px;" onclick="openAddModal('Todo')"><i class="fa-solid fa-plus"></i></button>
                </div>
                <div id="list-todo"></div>
            </div>
        </div>
      `;
      renderList(document.getElementById('list-rem'), reminders, true);
      renderList(document.getElementById('list-todo'), todos, true);
    }
  }

  function renderList(el, items, sortable) {
    if(!items.length) { el.innerHTML = '<div class="text-center text-muted py-5 opacity-50"><i class="fa-solid fa-inbox fa-3x mb-3"></i><br>暫無項目</div>'; return; }
    
    el.innerHTML = items.map(item => {
      let daysHtml = '';
      
      // 計算天數邏輯
      if(item.type === 'Reminder' && item.dateValue) {
        let today = new Date();
        today.setHours(0,0,0,0); // 正規化今天時間
        let target = new Date(item.dateValue);
        target.setHours(0,0,0,0);
        
        // 算出天數差距
        let diff = Math.floor((today - target) / (1000*60*60*24));
        
        let badgeClass = '';
        let badgeText = '';

        if (diff > 0) {
            // 過去日期 (已過 XX 天)
            badgeClass = diff > 30 ? 'overdue' : '';
            badgeText = `已過 ${diff} 天`;
        } else if (diff < 0) {
            // 未來日期 (還有 XX 天)
            badgeClass = 'future';
            badgeText = `還有 ${Math.abs(diff)} 天`;
        } else {
            // 今天
            badgeClass = 'today';
            badgeText = '就是今天';
        }
        
        // 顯示：天數Badge + 重置按鈕
        daysHtml = `
            <div class="d-flex align-items-center">
                <span class="days-badge ${badgeClass}">${badgeText}</span>
                <button class="btn btn-reset shadow-sm" onclick="resetReminderDate('${item.id}')" title="重置為今天">
                    <i class="fa-solid fa-rotate-left me-1"></i>重置
                </button>
            </div>
        `;
      }

      return `
        <div class="card item-row ${item.isDone?'opacity-50':''}" data-id="${item.id}">
          <div class="item-top-row">
            ${sortable ? '<div class="me-3 text-muted drag-handle" style="cursor:grab;"><i class="fa-solid fa-grip-vertical"></i></div>' : ''}
            <i class="star-btn fa-${item.isStarred?'solid':'regular'} fa-star ${item.isStarred?'active':''}" onclick="updateField('${item.id}','isStarred',!${item.isStarred})"></i>
            ${item.type==='Todo'?`<input type="checkbox" class="form-check-input me-3 shadow-sm" style="width: 1.2em; height: 1.2em;" ${item.isDone?'checked':''} onchange="updateField('${item.id}','isDone',this.checked)">`:''}
            <div class="item-content-text ${item.isDone?'strikethrough':''}">${item.content}</div>
          </div>
          <div class="item-bottom-row">
             <div>${daysHtml}</div>
             <button class="btn btn-icon-text bg-light text-secondary shadow-sm ms-auto" onclick="openEditModal('${item.id}')"><i class="fa-solid fa-pen me-1"></i>編輯</button>
          </div>
        </div>`;
    }).join('');

    if(sortable) new Sortable(el, { handle: '.drag-handle', animation: 150, ghostClass: 'bg-light', onEnd: saveOrder });
  }

  async function saveTopGoal(el) { 
    el.classList.add('saving');
    const res = await callApi('saveTopGoal', { category: currentCategory, content: el.value }); 
    if(res) {
        allData = res.items; 
        el.classList.remove('saving');
        el.classList.add('saved');
        document.getElementById('save-status-text').style.opacity = '1';
        setTimeout(() => {
            el.classList.remove('saved');
            document.getElementById('save-status-text').style.opacity = '0';
        }, 1500);
    }
  }

  async function updateField(id, field, val) {
    let item = allData.find(d => d.id == id); if(item) { item[field] = val; renderContent(); }
    const res = await callApi('updateItem', { id: id, field: field, value: val }); if(res) allData = res.items;
  }
  
  // 重置日期為今天
  async function resetReminderDate(id) {
    document.getElementById('loading').style.display = 'flex';
    // 取得今天日期 YYYY-MM-DD
    let today = new Date();
    today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
    let dateStr = today.toISOString().slice(0,10);
    
    // 呼叫 API 更新
    const res = await callApi('updateItem', { id: id, field: 'dateValue', value: dateStr });
    if(res) { allData = res.items; renderContent(); }
    document.getElementById('loading').style.display = 'none';
  }

  async function saveOrder() {
    let ids = []; document.querySelectorAll('.item-row').forEach(el => ids.push(el.getAttribute('data-id')));
    await callApi('updateOrder', { ids: ids });
  }
  
  function openAddModal(type) {
    document.getElementById('modalTitle').innerText = type === 'Reminder' ? '新增提醒' : '新增待辦';
    document.getElementById('editId').value = ''; document.getElementById('editType').value = type;
    document.getElementById('editContent').value = ''; document.getElementById('btnDelete').style.display = 'none';
    document.getElementById('editDateGroup').classList.toggle('d-none', type !== 'Reminder');
    if(type === 'Reminder') {
        let now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('editDate').value = now.toISOString().slice(0,10);
    }
    editModal.show();
  }
  function openEditModal(id) {
    let item = allData.find(d => d.id == id); if(!item) return;
    document.getElementById('modalTitle').innerText = '編輯項目';
    document.getElementById('editId').value = item.id; document.getElementById('editType').value = item.type;
    document.getElementById('editContent').value = item.content; document.getElementById('editDate').value = item.dateValue || '';
    document.getElementById('btnDelete').style.display = 'block';
    document.getElementById('editDateGroup').classList.toggle('d-none', item.type !== 'Reminder');
    editModal.show();
  }
  async function saveEdit() {
    document.getElementById('loading').style.display = 'flex'; editModal.hide();
    let id = document.getElementById('editId').value;
    let payload = { category: currentCategory, type: document.getElementById('editType').value, content: document.getElementById('editContent').value, dateValue: document.getElementById('editDate').value };
    let res;
    if(id) {
        await callApi('updateItem', { id: id, field: 'content', value: payload.content });
        if(payload.type === 'Reminder') res = await callApi('updateItem', { id: id, field: 'dateValue', value: payload.dateValue });
        else res = await callApi('getData');
    } else res = await callApi('addItem', { item: payload });
    if(res) { allData = res.items; renderContent(); }
    document.getElementById('loading').style.display = 'none';
  }
  async function deleteEdit() {
    if(!confirm('確認刪除此項目？')) return;
    document.getElementById('loading').style.display = 'flex'; editModal.hide();
    const res = await callApi('deleteItem', { id: document.getElementById('editId').value });
    if(res) { allData = res.items; renderContent(); }
    document.getElementById('loading').style.display = 'none';
  }
</script>
</body>
</html>
