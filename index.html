<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>夢想藍圖</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  
  <style>
    /* 這裡貼上所有樣式，保持簡潔 */
    body { background-color: #f0f2f5; padding-bottom: 140px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-user-select: none; user-select: none; }
    
    /* 登入遮罩 */
    #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    
    /* 底部導覽列 */
    .nav-container { position: fixed; bottom: 0; left: 0; width: 100%; background: white; z-index: 1000; box-shadow: 0 -2px 15px rgba(0,0,0,0.08); display: flex; flex-direction: column; }
    .nav-categories-scroll { display: flex; overflow-x: auto; white-space: nowrap; padding: 10px 5px; -ms-overflow-style: none; scrollbar-width: none; }
    .nav-categories-scroll::-webkit-scrollbar { display: none; }
    
    .nav-cat-item { display: inline-flex; flex-direction: column; align-items: center; min-width: 70px; padding: 5px; color: #95a5a6; text-decoration: none; border-radius: 8px; transition: 0.2s; }
    .nav-cat-item.active { background-color: #eaf2f8; color: #2980b9; font-weight: bold; }
    
    .nav-home-area { padding: 10px 15px; border-top: 1px solid #eee; }
    .btn-home-large { width: 100%; background: #2c3e50; color: white; border: none; border-radius: 50px; padding: 12px; font-weight: 700; transition: 0.1s; }
    .btn-home-large:active { transform: scale(0.98); }
    .btn-home-large.active { background: #34495e; }

    /* 卡片與列表 */
    .card { border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 12px; border-radius: 12px; }
    .item-row { padding: 15px; background: white; }
    .item-top-row { display: flex; align-items: flex-start; margin-bottom: 8px; }
    .item-content-text { font-size: 1rem; font-weight: 600; color: #34495e; flex-grow: 1; word-break: break-word;}
    .item-bottom-row { display: flex; justify-content: space-between; align-items: center; padding-top: 8px; border-top: 1px solid #f8f9fa; }
    
    .star-btn { color: #ecf0f1; cursor: pointer; font-size: 1.3rem; margin-right: 10px; transition: color 0.2s; }
    .star-btn.active { color: #f1c40f; }
    .strikethrough { text-decoration: line-through; color: #bdc3c7; }
    .opacity-50 { opacity: 0.5; }
    
    .days-badge { font-size: 0.75rem; padding: 4px 10px; border-radius: 15px; background: #ecf0f1; color: #7f8c8d; }
    .days-badge.overdue { background: #fadbd8; color: #c0392b; }
    
    .btn-icon-text { font-size: 0.75rem; padding: 4px 10px; border-radius: 6px; }
    .category-header { padding: 20px; background: white; margin-bottom: 15px; border-radius: 0 0 20px 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
    
    #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction: column;}
  </style>
</head>
<body>

  <div id="login-overlay">
    <div class="mb-5 text-center">
      <h1 class="fw-bold text-primary mb-2"><i class="fa-solid fa-rocket me-2"></i>夢想藍圖</h1>
      <p class="text-secondary">請使用 Google 帳號登入</p>
    </div>
    <div id="g_id_onload"
         data-client_id="588153257798-88o3tpdc6m8545frq4qcsd3ou31cnhgn.apps.googleusercontent.com"
         data-callback="handleCredentialResponse"
         data-auto_select="true"
         data-auto_prompt="false">
    </div>
    <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with" data-shape="pill" data-logo_alignment="left"></div>
  </div>

  <div id="loading" style="display:none;">
    <div class="spinner-border text-primary" role="status"></div>
    <div class="mt-3 text-secondary small fw-bold">同步雲端資料中...</div>
  </div>

  <div id="app-content" class="container-fluid p-0"></div>

  <div class="nav-container">
    <div class="nav-categories-scroll" id="nav-categories"></div>
    <div class="nav-home-area">
      <button class="btn-home-large" id="btn-home-large" onclick="switchCategory('Home')">
        <i class="fa-solid fa-house me-2"></i> 首頁 / 整體目標
      </button>
    </div>
  </div>

  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow">
        <div class="modal-body">
          <input type="hidden" id="editId"><input type="hidden" id="editType">
          <textarea class="form-control mb-3 p-3 bg-light border-0" id="editContent" rows="4" placeholder="輸入內容..." style="font-size:1.1rem;"></textarea>
          <div id="editDateGroup" class="d-none bg-light p-3 rounded-3">
             <label class="form-label text-muted small fw-bold mb-1">日期</label>
             <input type="date" class="form-control border-0 bg-white" id="editDate">
          </div>
        </div>
        <div class="modal-footer border-0 pt-0">
          <button type="button" class="btn btn-light text-danger me-auto" id="btnDelete"><i class="fa-solid fa-trash me-1"></i>刪除</button>
          <button type="button" class="btn btn-primary px-4 rounded-pill" id="btnSave">儲存</button>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

<script>
  // ===========================================
  // 設定區 (請修改這裡)
  // ===========================================
  const API_URL = "https://script.google.com/macros/s/AKfycbyP482eL57B-4AVECqq4cmU6nw5s_f6V1fzhWoXB9-ItvLwQuWg-zcqHkXs-0jYm2fGVg/exec"; 
  const CLIENT_ID = "AKfycbyP482eL57B-4AVECqq4cmU6nw5s_f6V1fzhWoXB9-ItvLwQuWg-zcqHkXs-0jYm2fGVg"; 
  // 記得也要修改 HTML 上方 data-client_id 的值
  // ===========================================

  let userToken = localStorage.getItem("google_token");
  let allData = [];
  let currentCategory = 'Home';
  let editModal;

  const DOMAINS = [
    { id: 'Health', name: '健康', icon: 'fa-heart-pulse' },
    { id: 'Rest', name: '休養', icon: 'fa-book-open' },
    { id: 'Spirit', name: '心靈', icon: 'fa-spa' },
    { id: 'Work', name: '工作', icon: 'fa-briefcase' },
    { id: 'Family', name: '家庭', icon: 'fa-user-group' },
    { id: 'Money', name: '經濟', icon: 'fa-sack-dollar' }
  ];

  window.onload = function() {
    // 初始化 UI
    renderNavbar();
    editModal = new bootstrap.Modal(document.getElementById('editModal'));
    document.getElementById('btnSave').onclick = saveEdit;
    document.getElementById('btnDelete').onclick = deleteEdit;

    // 檢查是否有 Token
    if (userToken) {
      document.getElementById('login-overlay').style.display = 'none';
      loadData();
    }
  };

  // --- Google 登入處理 ---
  function handleCredentialResponse(response) {
    userToken = response.credential;
    localStorage.setItem("google_token", userToken);
    document.getElementById('login-overlay').style.display = 'none';
    loadData();
  }

  // --- API 核心 ---
  async function callApi(action, payload = {}) {
    if (!userToken) {
      document.getElementById('login-overlay').style.display = 'flex';
      return null;
    }

    try {
      payload.token = userToken; 
      let response;
      
      // 統一使用 POST 傳輸，確保 Token 完整傳遞
      response = await fetch(API_URL, {
        method: 'POST',
        headers: { "Content-Type": "text/plain;charset=utf-8" }, // GAS 需要 text/plain 避免預檢
        body: JSON.stringify({ action: action, ...payload })
      });
      
      const data = await response.json();

      if (data && data.error === 'Unauthorized') {
        alert("登入已過期，請重新登入");
        localStorage.removeItem("google_token");
        userToken = null;
        document.getElementById('login-overlay').style.display = 'flex';
        return null;
      }
      return data;
    } catch (error) {
      console.error(error);
      alert('無法連線到伺服器');
      document.getElementById('loading').style.display = 'none';
      return null;
    }
  }

  // --- 資料與 UI ---
  async function loadData() {
    document.getElementById('loading').style.display = 'flex';
    // 第一次讀取可以用 GET 或 POST，這裡為了方便統一用 POST (雖然 API 支援 GET)
    // 但為了初次載入，我們模擬一個 getData action
    const res = await callApi('getData');
    if (res) {
      allData = res.items || [];
      renderContent();
    }
    document.getElementById('loading').style.display = 'none';
  }

  function renderNavbar() {
    const navScroll = document.getElementById('nav-categories');
    let html = DOMAINS.map(cat => `
      <a href="javascript:void(0)" class="nav-cat-item ${cat.id === currentCategory ? 'active' : ''}" onclick="switchCategory('${cat.id}')">
        <i class="fa-solid ${cat.icon}"></i><span>${cat.name}</span>
      </a>
    `).join('');
    navScroll.innerHTML = html;
    
    const btnHome = document.getElementById('btn-home-large');
    if (currentCategory === 'Home') {
      btnHome.classList.add('active');
      btnHome.innerHTML = '<i class="fa-solid fa-house me-2"></i> 首頁 / 整體目標';
    } else {
      btnHome.classList.remove('active');
      btnHome.innerHTML = '<i class="fa-solid fa-house me-2"></i> 回首頁';
    }
  }

  function switchCategory(id) {
    currentCategory = id;
    renderNavbar();
    window.scrollTo(0,0);
    renderContent();
  }

  function renderContent() {
    const container = document.getElementById('app-content');
    container.innerHTML = '';
    
    // Header (Goal)
    let goal = allData.find(d => d.category === currentCategory && d.type === 'Goal')?.content || '';
    let headerHtml = `
      <div class="category-header">
        <h5 class="mb-3 text-dark fw-bold"><i class="fa-solid ${currentCategory === 'Home' ? 'fa-earth-americas' : DOMAINS.find(c=>c.id===currentCategory).icon} me-2 text-primary"></i>${currentCategory === 'Home' ? 'My Vision' : DOMAINS.find(c=>c.id===currentCategory).name}</h5>
        <textarea class="form-control border-0 bg-light rounded-3 p-3" rows="3" placeholder="設定您的目標..." onblur="saveTopGoal(this)">${goal}</textarea>
      </div>`;
    container.innerHTML = headerHtml;

    // List Items
    if (currentCategory === 'Home') {
      let starred = allData.filter(d => d.isStarred && d.type !== 'Goal');
      container.innerHTML += `<div class="px-3 pb-2 text-secondary fw-bold small">重點關注</div><div id="list-home" class="px-2 pb-5"></div>`;
      renderList(document.getElementById('list-home'), starred, false);
    } else {
      let reminders = allData.filter(d => d.category === currentCategory && d.type === 'Reminder');
      let todos = allData.filter(d => d.category === currentCategory && d.type === 'Todo');
      
      container.innerHTML += `<div class="d-flex justify-content-between px-3 mt-2"><span class="fw-bold small text-secondary">提醒與追蹤</span><i class="fa-solid fa-plus text-primary" onclick="openAddModal('Reminder')"></i></div><div id="list-rem" class="px-2"></div>`;
      renderList(document.getElementById('list-rem'), reminders, true);
      
      container.innerHTML += `<div class="d-flex justify-content-between px-3 mt-4"><span class="fw-bold small text-secondary">待辦事項</span><i class="fa-solid fa-plus text-primary" onclick="openAddModal('Todo')"></i></div><div id="list-todo" class="px-2 mb-5"></div>`;
      renderList(document.getElementById('list-todo'), todos, true);
    }
  }

  function renderList(el, items, sortable) {
    if(!items.length) { el.innerHTML = '<div class="text-center text-muted py-3 small opacity-25">暫無項目</div>'; return; }
    
    el.innerHTML = items.map(item => {
      let daysBadge = '';
      if(item.type === 'Reminder' && item.dateValue) {
        let diff = Math.floor((new Date() - new Date(item.dateValue))/(1000*60*60*24));
        daysBadge = `<span class="days-badge ${diff>30?'overdue':''} ms-auto"><i class="fa-regular fa-clock me-1"></i>${diff}天</span>`;
      }
      return `
        <div class="card item-row ${item.isDone?'opacity-50':''}" data-id="${item.id}">
          <div class="item-top-row">
            ${sortable ? '<div class="me-2 text-muted drag-handle"><i class="fa-solid fa-grip-vertical"></i></div>' : ''}
            <i class="star-btn fa-${item.isStarred?'solid':'regular'} fa-star ${item.isStarred?'active':''}" onclick="updateField('${item.id}','isStarred',!${item.isStarred})"></i>
            ${item.type==='Todo'?`<input type="checkbox" class="form-check-input me-2" ${item.isDone?'checked':''} onchange="updateField('${item.id}','isDone',this.checked)">`:''}
            <div class="item-content-text ${item.isDone?'strikethrough':''}">${item.content}</div>
          </div>
          <div class="item-bottom-row">
             ${daysBadge}
             <button class="btn btn-icon-text bg-light text-secondary ms-auto" onclick="openEditModal('${item.id}')"><i class="fa-solid fa-pen"></i></button>
          </div>
        </div>`;
    }).join('');

    if(sortable) new Sortable(el, { handle: '.drag-handle', animation: 150, onEnd: saveOrder });
  }

  // --- Actions ---
  async function saveTopGoal(el) {
    await callApi('saveTopGoal', { category: currentCategory, content: el.value });
  }
  async function updateField(id, field, val) {
    let item = allData.find(d => d.id == id);
    if(item) { item[field] = val; renderContent(); } // UI Optimistic update
    const res = await callApi('updateItem', { id: id, field: field, value: val });
    if(res) allData = res.items;
  }
  async function saveOrder() {
    let ids = [];
    document.querySelectorAll('.item-row').forEach(el => ids.push(el.getAttribute('data-id')));
    await callApi('updateOrder', { ids: ids });
  }
  
  // --- Edit Modal ---
  function openAddModal(type) {
    document.getElementById('editId').value = '';
    document.getElementById('editType').value = type;
    document.getElementById('editContent').value = '';
    document.getElementById('btnDelete').style.display = 'none';
    document.getElementById('editDateGroup').classList.toggle('d-none', type !== 'Reminder');
    editModal.show();
  }
  function openEditModal(id) {
    let item = allData.find(d => d.id == id);
    if(!item) return;
    document.getElementById('editId').value = item.id;
    document.getElementById('editType').value = item.type;
    document.getElementById('editContent').value = item.content;
    document.getElementById('editDate').value = item.dateValue || '';
    document.getElementById('btnDelete').style.display = 'block';
    document.getElementById('editDateGroup').classList.toggle('d-none', item.type !== 'Reminder');
    editModal.show();
  }
  async function saveEdit() {
    document.getElementById('loading').style.display = 'flex';
    editModal.hide();
    let id = document.getElementById('editId').value;
    let payload = {
      category: currentCategory,
      type: document.getElementById('editType').value,
      content: document.getElementById('editContent').value,
      dateValue: document.getElementById('editDate').value
    };
    
    let res;
    if(id) res = await callApi('updateItem', { id: id, field: 'content', value: payload.content }); // 簡化邏輯，這裡僅示範修改內容，若要修改日期需再呼叫一次或後端支援
    else res = await callApi('addItem', { item: payload });
    
    if(res) { allData = res.items; renderContent(); }
    document.getElementById('loading').style.display = 'none';
  }
  async function deleteEdit() {
    if(!confirm('確認刪除？')) return;
    document.getElementById('loading').style.display = 'flex';
    editModal.hide();
    const res = await callApi('deleteItem', { id: document.getElementById('editId').value });
    if(res) { allData = res.items; renderContent(); }
    document.getElementById('loading').style.display = 'none';
  }
</script>
</body>
</html>